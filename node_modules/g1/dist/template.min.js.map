{"version":3,"file":"template.min.js","sources":["../src/template.js","../src/_util.js","../index-template.js","../src/package.js"],"sourcesContent":["import { findall } from './_util.js'\n\nvar _renderer = 'g1.template.render'\nvar _compiled = 'g1.template.compiled'\nvar _prev_created = 'g1.template.prev_created'\n\n\nfunction subtemplates($main) {\n  // Takes a main template as a jQuery node with data-template-<name>=\"selector\" attributes.\n  // Return an object of {name: selector}\n  return _.chain($main.data())\n    .pickBy(function (val, key) { return key.match(/^template/) })\n    .mapKeys(function (val, key) { return key.replace(/^template/, '').toLowerCase() })\n    .value()\n}\n\nexport function template(data, options) {\n  options = options || {}\n  var self = this\n  var selector = options.selector || self.data('selector') || 'script[type=\"text/html\"],template'\n\n  // Pre-create the template rendering function\n  // Store this in .data('template.function')\n  findall(self, selector).each(function () {\n    var $this = $(this)\n    // If we want to dispose the last target, just dispose it.\n    if (data === 'dispose') {\n      var $oldtarget = $this.data(_prev_created)\n      if ($oldtarget)\n        $oldtarget.remove()\n      return $this.trigger({\n        type: 'template',\n        templatedata: data,\n        target: $oldtarget\n      })\n    }\n    var renderer = $this.data(_renderer)\n    // If the renderer is already present, just use it. Else compile it\n    if (renderer)\n      renderer(data, options)\n    // If there are subtemplate dependencies, compile them\n    else if (_.size(subtemplates($this)))\n      dependent_templates($this, self, data, options)\n    // If there aren't, then compile immediately.\n    else\n      make_template($this, data, options)\n  })\n  return this\n}\n\nfunction dependent_templates(selector, self, data, options) {\n  var uncompiled_selectors = _.pickBy(subtemplates(selector), function (sel) {\n    return !$(sel).data(_compiled)\n  })\n  return Promise.all(\n    _.map(uncompiled_selectors, function (sel) { return dependent_templates($(sel), self, data, options) })\n  ).then(function () {\n    return Promise.all(\n      _.union(\n        _.map(uncompiled_selectors, function (sel) { return make_template($(sel), data, options) }),\n        make_template(selector, data, options)\n      )\n    )\n  })\n    .catch(function (error) { console.error(error) }) // eslint-disable-line no-console\n}\n\nfunction make_template($this, data, options) {\n  // Compile templates. If the template has src=\"\", load it and then compile it.\n  // The result is in $this.data(_compiled) (via make_template_sync).\n  var html = $this.html()\n  // Contents of script are regular strings. Contents of template are escaped\n  if (!$this.is('script'))\n    html = _.unescape(html)\n\n  var src = $this.attr('src')\n  if (src) {\n    // If the AJAX load succeeds, render the loaded template\n    // Else render the contents, with an additional xhr variable\n    return $.get(src).done(function (html) {\n      make_template_sync($this, html, data, options)\n    }).fail(function (xhr) {\n      data.xhr = xhr\n      make_template_sync($this, html, data, options)\n    })\n  }\n  // If no src= is specified, just render the contents\n  else make_template_sync($this, html, data, options)\n}\n\n\n// Bind a template renderer to the node $this.data('template.render')\n// This renderer function accepts (data, options) and creates\n//    - runs the html template, parses the result, and create a target node\n//    - appends the target node after $this (clearing any previous target nodes)\n//    - stores the target node in $this.data('template.target')\n//    - triggers a template event (with .templatedata, .target)\n//    - returns the target node\nfunction make_template_sync($this, html, data, default_options) {\n  var compiled_template = _.template(html)\n  var $created\n\n  // $this.data(_compiled) has the compiled template. This adds sub-template\n  // variables from data-template-* attributes.\n  $this.data(_compiled, function (subtemplate_data) {\n    subtemplate_data = _.extend(\n      {$node: $this, $data: $this.data()},\n      _.mapValues(subtemplates($this), function (selector) { return $(selector).data(_compiled) }),\n      subtemplate_data || {}\n    )\n    return compiled_template(subtemplate_data)\n  })\n\n  function renderer(data, options) {\n    html = $this.data(_compiled)(data)\n    // Get options. DOM data-* over-rides JS options\n    var append = $this.data('append') || (options ? options.append : default_options.append)\n    var target = $this.data('target') || (options ? options.target : default_options.target)\n    var engine = $this.data('engine') || (options ? options.engine : default_options.engine)\n    if (!engine || typeof engine == 'string')\n      engine = template.engines[engine] || template.engines['default']\n    // If we're appending the contents, just add the text\n    if (append) {\n      $created = $($.parseHTML(html.trim()))\n      // If we're appending to a target node, just append to it.\n      if (target)\n        $(target).append($created)\n      // If no target node, add BEFORE template. Future appends will be in sequence\n      else\n        $this.before($created)\n    }\n    // If we're not appending, replace the contents using the renderer\n    else {\n      // The engine must return the created nodes. See template.engines spec below\n      $created = engine($this, target, html)\n      // Store the created nodes for future reference. See template.engines spec below\n      $this.data(_prev_created, $created)\n    }\n    // Trigger the template event. Use \"templatedata\" since \".data\" is reserved\n    $this.trigger({ type: 'template', templatedata: data, target: $created })\n    return $created\n  }\n  $this.data(_renderer, renderer)\n  return $this.data('target') !== false ? renderer(data) : null\n}\n\n\n// $.fn.template.engines is a registry of rendering engines. Each entry is a\n// function that accepts 3 parameters:\n//    $this: the <script> element\n//    target: the target selector or node to render into. May be undefined\n//    html: the HTML to render at the target (or around $this if target is missing)\n// It returns the created nodes as a jQuery object. This is used in 2 ways:\n//    - the template event.target attribute is this return value\n//    - $this.data(_prev_created) is set to this return value\ntemplate.engines = {}\n\n// The default engine uses jQuery\ntemplate.engines['default'] = template.engines['jquery'] = function ($this, target, html) {\n  // Parse the template output and create a node collection\n  // $.parseHTML ensures that \"hello\" is parsed as HTML, not a selector\n  var $target = $($.parseHTML(html.trim()))\n  // If target exists, replace the HTML. Otherwise, create new nodes before the template.\n  if (target)\n    $(target).html($target)\n  else {\n    // Remove any previous targets and re-create the output\n    var $oldtarget = $this.data(_prev_created)\n    if ($oldtarget)\n      $oldtarget.remove()\n    $this.before($target)\n  }\n  return $target\n}\n\n/* globals morphdom */\ntemplate.engines['vdom'] = function ($this, target, html) {\n  // If no target is specified, use the previous target, if any\n  target = target || $this.data(_prev_created)\n  // If a target is specified, wrap the HTML with the target node.\n  // For example, <div id=\"target\">...</div> will wrap the HTML with\n  // <div id=\"target\"></div>\n  var $target, tag_open, tag_close\n  if (target) {\n    $target = $(target)\n    var node = $target.get(0)\n    tag_open = '<' + node.nodeName\n    $.each(node.attributes, function () {\n      tag_open += ' ' + this.name + '=' + this.value\n    })\n    tag_open += '>'\n    tag_close = '</' + node.nodeName + '>'\n  }\n  // If a target is not specified, Create the target node before the template.\n  // Wrap the HTML and the node with <div> to ensure that it's a single node.\n  // Morphdom requires a single node.\n  else {\n    tag_open = '<div>'\n    tag_close = '</div>'\n    $target = $(tag_open + tag_close).insertBefore($this)\n  }\n  $target.each(function () {\n    morphdom(this, tag_open + html + tag_close)\n  })\n  return $target\n}\n","// jQuery utilities.\n// These are NOT jQuery plugins. They accept a $node directly.\n// These are NOT exposed as part of the API. Purely internal.\n\n// Return all values that match the selector\n// AMONG and UNDER the $node\nexport function findall($node, selector) {\n  return $node.filter(selector).add($node.find(selector))\n}\n\n// Return all values that DO NOT match the selector\n// AMONG and UNDER the $node. Complement of findall\nexport function notall($node, selector) {\n  return $node.not(selector).add($node.not(selector))\n}\n\n// Returns true if data attribute is present\n//    But if the value is \"false\", \"off\", \"n\" or \"no\" in any case, returns false (like YAML)\n// Returns default_value if data attribute is missing\nexport function hasdata($node, key, default_value) {\n  var val = $node.data(key)\n  if (typeof val == 'undefined' || val === false || val === null)\n    return default_value\n  if (typeof val == 'string' && val.match(/^(false|off|n|no)$/i))\n    return false\n  return true\n}\n\n// Return the {width:..., height:...} of the node\nexport function getSize($node) {\n  // Ideally, this is just one line:\n  //    return $node.getBoundingClientRect()\n\n  // But see http://stackoverflow.com/q/18153989/100904\n  // and https://bugzilla.mozilla.org/show_bug.cgi?id=530985\n  // If the contents exceed the bounds of an element,\n  // getBoundingClientRect() failes in Firefox.\n\n  // So set display:block, get $().width(), and unset display:block\n  $node = $($node)\n  var old_display = $node.css('display'),\n      result = {}\n  if (old_display != 'block')\n    $node.css('display', 'block')\n  result.width = $node.width()\n  result.height = $node.height()\n  if (old_display != 'block')\n    $node.css('display', old_display)\n  return result\n}\n","export { version } from './src/package.js'\nimport { template } from './src/template.js'\n\nif (typeof jQuery != 'undefined') {\n  jQuery.extend(jQuery.fn, {\n    template: template\n  })\n}\n","export var name = \"g1\";\r\nexport var version = \"0.17.3\";\r\nexport var description = \"Gramex 1.x interaction library\";\r\nexport var license = \"MIT\";\r\nexport var author = \"S Anand <s.anand@gramener.com>\";\r\nexport var module = \"modules.js\";\r\nexport var main = \"dist/g1.js\";\r\nexport var jsdelivr = \"dist/g1.min.js\";\r\nexport var unpkg = \"dist/g1.min.js\";\r\nexport var repository = {\"type\":\"git\",\"url\":\"git@code.gramener.com:s.anand/g1.git\"};\r\nexport var scripts = {\"lint\":\"eslint index*.js src && eclint check '**/*.html' '**/*.js' '**/*.css' '**/*.yaml' '**/*.md'\",\"build\":\"rimraf dist && json2module package.json > src/package.js && rollup -c\",\"dev\":\"rimraf dist && json2module package.json > src/package.js && rollup -c -w\",\"pretest\":\"npm run lint && npm run build && browserify -s tape -r tape -o test/tape.js\",\"server\":\"npm run pretest && npm run lint && node test/server.js\",\"test\":\"tape test/test-*.js | faucet && node test/server.js puppeteer | tap-merge | faucet\",\"test-chrome\":\"node test/server.js chrome | tap-merge | faucet\",\"test-edge\":\"node test/server.js MicrosoftEdge | tap-merge | faucet\",\"test-firefox\":\"node test/server.js firefox | tap-merge | faucet\",\"prepublishOnly\":\"npm test\"};\r\nexport var devDependencies = {\"babel-core\":\"6\",\"babel-plugin-external-helpers\":\"6\",\"babel-plugin-transform-runtime\":\"6\",\"babel-preset-env\":\"1\",\"babel-preset-es2015\":\"6\",\"babelrc-rollup\":\"3\",\"bootstrap\":\"4.1\",\"bootstrap-select\":\"1.13\",\"browserify\":\"14\",\"component-emitter\":\"1\",\"d3\":\"4\",\"d3-scale-chromatic\":\"1\",\"deepmerge\":\"2\",\"eclint\":\"2\",\"es6-promise\":\"4\",\"eslint\":\"4\",\"events-polyfill\":\"2\",\"express\":\"4\",\"faucet\":\"0.0\",\"font-awesome\":\"4\",\"glob\":\"7.1\",\"html-minifier\":\"3\",\"is-plain-object\":\"2\",\"jquery\":\"3\",\"json2module\":\"0.0\",\"leaflet\":\"1.3\",\"lodash\":\"4\",\"moment\":\"2\",\"morphdom\":\"2\",\"numeral\":\"2\",\"popper.js\":\"1\",\"puppeteer\":\"0.13\",\"regenerator-runtime\":\"0.11\",\"rimraf\":\"2\",\"rollup\":\"1\",\"rollup-plugin-babel\":\"3\",\"rollup-plugin-commonjs\":\"10\",\"rollup-plugin-node-resolve\":\"5\",\"rollup-plugin-uglify\":\"6\",\"rollup-pluginutils\":\"2\",\"selenium-webdriver\":\"3\",\"tap-merge\":\"0.3\",\"tape\":\"4\",\"topojson\":\"3\",\"unfetch\":\"3\"};\r\nexport var dependencies = {\"d3-array\":\"2\",\"lodash-es\":\"4\"};\r\n"],"names":["_renderer","_compiled","_prev_created","subtemplates","$main","_","chain","data","pickBy","val","key","match","mapKeys","replace","toLowerCase","value","template","options","self","this","selector","$node","filter","add","find","findall","each","$this","$","$oldtarget","remove","trigger","type","templatedata","target","renderer","size","dependent_templates","uncompiled_selectors","sel","Promise","all","map","then","union","make_template","catch","error","console","html","is","unescape","src","attr","get","done","make_template_sync","fail","xhr","default_options","$created","compiled_template","append","engine","engines","parseHTML","trim","before","subtemplate_data","extend","$data","mapValues","$target","tag_open","tag_close","node","nodeName","attributes","name","insertBefore","morphdom","jQuery","fn"],"mappings":"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"}