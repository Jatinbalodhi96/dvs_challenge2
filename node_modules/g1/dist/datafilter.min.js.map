{"version":3,"file":"datafilter.min.js","sources":["../src/types.js","../src/datafilter.js","../src/namespace_util.js","../src/package.js"],"sourcesContent":["// state_transition[old_state][current_type] -> new_state\n// type: undefined and type: null are mapped to state 'null', i.e. missing values\nvar state_transitions = {\n  'null': {\n    'null': { state: 'null' },\n    'date': { state: 'date' },\n    'number': { state: 'number' },\n    'boolean': { state: 'boolean' },\n    'string': { state: 'string' },\n    'object': { state: 'object' },\n    'mixed': { state: 'mixed', end: true }\n  },\n  'date': {\n    'null': { state: 'date' },\n    'undefined': { state: 'date' },\n    'date': { state: 'date' },\n    'default': { state: 'mixed', end: true }\n  },\n  'number': {\n    'null': { state: 'number' },\n    'undefined': { state: 'number' },\n    'number': { state: 'number' },\n    'default': { state: 'mixed', end: true }\n  },\n  'boolean': {\n    'null': { state: 'boolean' },\n    'undefined': { state: 'boolean' },\n    'boolean': { state: 'boolean' },\n    'default': { state: 'mixed', end: true }\n  },\n  'string': {\n    'null': { state: 'string' },\n    'undefined': { state: 'string' },\n    'string': { state: 'string' },\n    'default': { state: 'mixed', end: true }\n  },\n  'object': {\n    'null': { state: 'object' },\n    'object': { state: 'object' },\n    'undefined': { state: 'object' },\n    'default': { state: 'mixed', end: true }\n  },\n  'mixed': {\n    'default': { state: 'mixed', end: true }\n  }\n}\n\n\nexport function types(data, options) {\n  var result = {}\n  if (!data || !data.length)\n    return result\n\n  options = options || {}\n  options.convert = options.convert || false\n  options.limit = options.limit || 1000\n  var limit = (options.limit < data.length) ? options.limit : data.length\n  var ignore = options.ignore = options.ignore || [null, undefined]\n  var columns = Object.keys(data[0])\n\n  for (var columnIndex = 0; columnIndex < columns.length; columnIndex++) {\n    var column = columns[columnIndex]\n    var result_type = 'null'\n    for (var index = 0; index < limit; index++) {\n      var row = data[index]\n      var value = row[column]\n\n      if (columnIndex == 0) {\n        Object.keys(data[index]).forEach(function (value) {\n          if (columns.indexOf(value) == -1)\n            columns.push(value)\n        })\n      }\n\n      // Ignore if the value is missing\n      if (!(column in row))\n        continue\n      // Ignore values that are in the ignore list\n      if (ignore.indexOf(value) >= 0)\n        continue\n      // Identify type (date, object, number, boolean, string, undefined, null)\n      var type = typeof value\n      if (value === undefined || value === null)\n        type = 'null'\n      else if (type == 'object' && !isNaN(Date.parse(value)))\n        type = 'date'\n      else if (options.convert) {\n        // We use parseFloat AND isFinite because\n        // parseFloat('2018-01') is 2018 but isFinite('2018-01') is false\n        // Also, 'NaN', 'Infinity' and '-Infinity' should be treated as numbers\n        if ((!isNaN(parseFloat(value)) && isFinite(value)) || ['NaN', 'Infinity', '-Infinity'].indexOf(value) >= 0)\n          type = 'number'\n        else if (!isNaN(Date.parse(value)))\n          type = 'date'\n        else if (['true', 'false'].indexOf(value) != -1)\n          type = 'boolean'\n      }\n\n      // Apply the state change\n      var state_transition = state_transitions[type]\n      var change = state_transition[result_type] || state_transition['default']\n      result_type = change['state']\n      if (change['end'])\n        break\n    }\n    result[column] = result_type\n  }\n  return result\n}\n","import { namespace } from './namespace_util.js'\nimport { types } from './types.js'\n\nfunction isEqual(value, compare_with, criteria_satisfied) {\n  // to handle: ( ...Shape!&... ) or ( ...&Shape&... )\n  if (!value) {\n    return criteria_satisfied ? (compare_with == null) : (compare_with != null)\n  }\n  return value.indexOf(compare_with) != -1 ? !criteria_satisfied : criteria_satisfied\n}\n\nfunction greater_than(value, compare_with, include_equals) {\n  if ((isNaN(compare_with) && Date.parse(compare_with))) {\n    compare_with = Date.parse(compare_with)\n  }\n  if ((isNaN(value) && Date.parse(value))) {\n    value = Date.parse(value)\n  }\n  return include_equals ? (compare_with >= value) : (compare_with > value)\n}\nvar operators = {\n  '=': function (value, compare_with) {\n    return isEqual(value, compare_with, false)\n  },\n  '!': function (value, compare_with) {\n    return isEqual(value, compare_with, true)\n  },\n  '>': function (value, compare_with) {\n    return greater_than(value, compare_with, false)\n  },\n  '<': function (value, compare_with) {\n    return greater_than(compare_with, value, false)\n  },\n  '>~': function (value, compare_with) {\n    return greater_than(value, compare_with, true)\n  },\n  '<~': function (value, compare_with) {\n    return greater_than(compare_with, value, true)\n  },\n  '~': function (value, compare_with) {\n    return isEqual(compare_with, value[0], false)\n  },\n  '!~': function (value, compare_with) {\n    return isEqual(compare_with, value[0], true)\n  }\n}\n\nvar sorting = {\n  'string': function (value, compare_with, order) {\n    if (!order) order = 'asc'\n    // swap if 'desc'\n    if (order == 'desc')\n      value = [compare_with, compare_with = value][0]\n\n    return value.localeCompare(compare_with)\n  },\n  'number': function (value, compare_with, order) {\n    if (!order) order = 'asc'\n    // swap if 'desc'\n    if (order == 'desc')\n      value = [compare_with, compare_with = value][0]\n\n    return value - compare_with\n  }\n}\n\nfunction clone_pluck(source, include_keys, exclude_keys) {\n  if (include_keys.length == 0) include_keys = Object.keys(source)\n  var new_obj = {}\n  include_keys.forEach(function (key) {\n    if (exclude_keys.indexOf(key) < 0) new_obj[key] = source[key]\n  })\n  return new_obj\n}\n\n\n\nexport function datafilter(data, filters, dataset_name) {\n  filters = filters || []\n\n  var result = data\n  var operator, value\n\n  // url namespace sanitize\n  filters = namespace(filters, dataset_name)\n\n  var data_types = types(data, { convert: true })\n\n  // apply WHERE clause\n  for (var key in filters) {\n    if (key[0] == '_') continue\n    var operator_index = (key.match(/(!|>|>~|<|<~|~|!~)$/)) ? key.match(/(!|>|>~|<|<~|~|!~)$/).index : key.length\n    operator = (key.slice(operator_index) != '') ? key.slice(operator_index) : '='\n    value = (filters[key][0] != \"\") ? filters[key] : null\n\n    var col = key.slice(0, operator_index)\n    if (data_types[col] == 'number') {\n      value = value.map(function(val) { return parseFloat(val)})\n    } else if (data_types[col] == 'boolean') {\n      value = value.map(function(val){ return String(val) == 'true' ? true : false})\n    } else if (data_types[col] == 'date') {\n      value = value.map(function(val) { return Date.parse(val) })\n    }\n\n    result = result.filter(function (row) {\n      return (typeof row[col] != 'undefined') ? operators[operator](value, row[col]) : true\n    })\n  }\n\n  var offset = parseInt(filters['_offset']) || 0\n  var limit = parseInt(filters['_limit']) || 1000\n\n  result = result.slice(offset, (offset + limit))\n\n  // apply SELECT clause\n  if (filters['_c']) {\n    var exclude_cols = [], include_cols = []\n    filters['_c'].forEach(function (column) {\n      column[0] == '-' ? exclude_cols.push(column.slice(1)) : include_cols.push(column)\n    })\n    result = result.map(function (row) {\n      return clone_pluck(row, include_cols, exclude_cols)\n    })\n  }\n\n  if (filters['_sort']) {\n    result.sort(function (a, b) {\n      var swap_rows = false\n      filters['_sort'].forEach(function (sort) {\n        var order = (sort[0] == '-') ? 'desc' : 'asc'\n        if (sort[0] == '-') sort = sort.substr(1)\n        if (typeof a[sort] == 'undefined') return\n        // if sort.column evaluates to false, it will proceed with evaluating || expression\n        var type = (isNaN(a[sort])) ? 'string' : 'number'\n        swap_rows = swap_rows || sorting[type](a[sort], b[sort], order)\n      })\n      return swap_rows\n    })\n  }\n\n  return result\n}\n","export function namespace(search, name) {\n  // Return an object with all keys in search that begin with `<name>:` or\n  // do not have a `:` in them.\n  // If name is false-y, return search\n  if (!name)\n    return search\n  var result = {}\n  for (var key in search) {\n    var parts = key.split(':')\n    if (parts.length == 1)\n      result[parts[0]] = search[key]\n    else if (parts[0] === name)\n      result[parts[1]] = search[key]\n  }\n  return result\n}\n","export var name = \"g1\";\r\nexport var version = \"0.17.3\";\r\nexport var description = \"Gramex 1.x interaction library\";\r\nexport var license = \"MIT\";\r\nexport var author = \"S Anand <s.anand@gramener.com>\";\r\nexport var module = \"modules.js\";\r\nexport var main = \"dist/g1.js\";\r\nexport var jsdelivr = \"dist/g1.min.js\";\r\nexport var unpkg = \"dist/g1.min.js\";\r\nexport var repository = {\"type\":\"git\",\"url\":\"git@code.gramener.com:s.anand/g1.git\"};\r\nexport var scripts = {\"lint\":\"eslint index*.js src && eclint check '**/*.html' '**/*.js' '**/*.css' '**/*.yaml' '**/*.md'\",\"build\":\"rimraf dist && json2module package.json > src/package.js && rollup -c\",\"dev\":\"rimraf dist && json2module package.json > src/package.js && rollup -c -w\",\"pretest\":\"npm run lint && npm run build && browserify -s tape -r tape -o test/tape.js\",\"server\":\"npm run pretest && npm run lint && node test/server.js\",\"test\":\"tape test/test-*.js | faucet && node test/server.js puppeteer | tap-merge | faucet\",\"test-chrome\":\"node test/server.js chrome | tap-merge | faucet\",\"test-edge\":\"node test/server.js MicrosoftEdge | tap-merge | faucet\",\"test-firefox\":\"node test/server.js firefox | tap-merge | faucet\",\"prepublishOnly\":\"npm test\"};\r\nexport var devDependencies = {\"babel-core\":\"6\",\"babel-plugin-external-helpers\":\"6\",\"babel-plugin-transform-runtime\":\"6\",\"babel-preset-env\":\"1\",\"babel-preset-es2015\":\"6\",\"babelrc-rollup\":\"3\",\"bootstrap\":\"4.1\",\"bootstrap-select\":\"1.13\",\"browserify\":\"14\",\"component-emitter\":\"1\",\"d3\":\"4\",\"d3-scale-chromatic\":\"1\",\"deepmerge\":\"2\",\"eclint\":\"2\",\"es6-promise\":\"4\",\"eslint\":\"4\",\"events-polyfill\":\"2\",\"express\":\"4\",\"faucet\":\"0.0\",\"font-awesome\":\"4\",\"glob\":\"7.1\",\"html-minifier\":\"3\",\"is-plain-object\":\"2\",\"jquery\":\"3\",\"json2module\":\"0.0\",\"leaflet\":\"1.3\",\"lodash\":\"4\",\"moment\":\"2\",\"morphdom\":\"2\",\"numeral\":\"2\",\"popper.js\":\"1\",\"puppeteer\":\"0.13\",\"regenerator-runtime\":\"0.11\",\"rimraf\":\"2\",\"rollup\":\"1\",\"rollup-plugin-babel\":\"3\",\"rollup-plugin-commonjs\":\"10\",\"rollup-plugin-node-resolve\":\"5\",\"rollup-plugin-uglify\":\"6\",\"rollup-pluginutils\":\"2\",\"selenium-webdriver\":\"3\",\"tap-merge\":\"0.3\",\"tape\":\"4\",\"topojson\":\"3\",\"unfetch\":\"3\"};\r\nexport var dependencies = {\"d3-array\":\"2\",\"lodash-es\":\"4\"};\r\n"],"names":["state_transitions","null","state","date","number","boolean","string","object","mixed","end","undefined","default","isEqual","value","compare_with","criteria_satisfied","indexOf","greater_than","include_equals","isNaN","Date","parse","operators","=","!",">","<",">~","<~","~","!~","sorting","order","localeCompare","data","filters","dataset_name","operator","result","search","name","key","parts","split","length","namespace","data_types","options","convert","limit","ignore","columns","Object","keys","columnIndex","column","result_type","index","row","forEach","push","type","parseFloat","isFinite","state_transition","change","types","operator_index","match","slice","col","map","val","String","filter","offset","parseInt","exclude_cols","include_cols","source","include_keys","exclude_keys","new_obj","clone_pluck","sort","a","b","swap_rows","substr"],"mappings":"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"}